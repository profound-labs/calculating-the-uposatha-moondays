\ProvidesPackage{duangchata}

\usepackage{calc}
\usepackage{tikz}
\usetikzlibrary{positioning}

\newcommand\duangThaiFont{}

\newcommand\theSun{{\duangThaiFont ๑}}
\newcommand\theMoon{{\duangThaiFont ๒}}

\newcommand\@dng@degree{\ensuremath{^\circ}}
\newcommand\@dng@minute{\ensuremath{^\prime}}

\newdimen\@t@result

% #1 = Rasi, #2 = Angsa (degree), #3 = Lipda (minute)
\newcommand\RalToDeg[3]{%
  \setlength{\@t@result}{30pt * #1}%
  \addtolength{\@t@result}{1pt * #2}%
  \addtolength{\@t@result}{1pt * #3 * \ratio{1pt}{60pt}}%
}

\newdimen\SunAngle
\newdimen\MoonAngle

\newdimen\angle
\newcount\nth

% #1 = Sun (r:a'l"), #2 = Moon (r:a'l")
\newcommand\DuangChata[2]{%
\begin{tikzpicture}

  \RalToDeg #1
  \setlength{\SunAngle}{\@t@result}
  \RalToDeg #2
  \setlength{\MoonAngle}{\@t@result}

  \node (0,0) [circle, draw=black, minimum width=200pt] {};
  
  % Naksatra
  \foreach \n/\@t@name in {0/{name},1/{name},2/{name},3/{name},4/{name},5/{name},6/{name},7/{name},8/{name},9/{name},10/{name},11/{name},12/{name},13/{name},14/{name},15/{name},16/{name},17/{name},18/{name},19/{name},20/{name},21/{name},22/{name},23/{name},24/{name},25/{name},26/{name}} {
    \setlength{\angle}{1pt * \n * \real{13.33}}
    \addtolength{\angle}{90pt - 15pt}% first Naksatra begins where the first Rasi begins

    \pgfpointpolar{\angle}{100pt}
    \pgfgetlastxy{\co@x}{\co@y}
    \draw (0,0) -- (\co@x,\co@y);

    \pgfpointpolar{\angle + 6.66pt}{95pt}
    \pgfgetlastxy{\co@x}{\co@y}
    \node [rotate={\angle - 90pt + 6.66pt}] at (\co@x,\co@y) {\small \thai{\@t@name}};

    \pgfpointpolar{\angle + 6.66pt}{105pt}
    \pgfgetlastxy{\co@x}{\co@y}
    \nth=\n
    \advance\nth by 1
    \node [rotate={\angle - 90pt + 6.66pt}] at (\co@x,\co@y) {\small \the\nth};
  }
  \node (0,0) [circle, draw=red, fill=white, minimum width=180pt] {};

  % Rasi
  \foreach \n/\@t@name in {0/{เมษ},1/{พฤษภ},2/{เมถุน},3/{กรกฎ},4/{สิงห์},5/{กันย์},6/{ตุลย์},7/{พิจิก},8/{ธนู},9/{มังกร},10/{กุมภ์},11/{มีน}} {
    \setlength{\angle}{1pt * \n * 30}
    \addtolength{\angle}{90pt - 15pt}% first Rasi is centered on 0 deg
    \pgfpointpolar{\angle}{90pt}
    \pgfgetlastxy{\co@x}{\co@y}
    \draw [red] (0,0) -- (\co@x,\co@y);

    \pgfpointpolar{\angle + 15pt}{80pt}
    \pgfgetlastxy{\co@x}{\co@y}
    \node [rotate={\angle - 90pt + 15pt}] at (\co@x,\co@y) {\small \thai{\@t@name}};

    \pgfpointpolar{\angle + 15pt}{70pt}
    \pgfgetlastxy{\co@x}{\co@y}
    \nth=\n
    \node [rotate={\angle - 90pt + 15pt}] at (\co@x,\co@y) {\small \the\nth};
  }
  
  % Zero degree
  \setlength{\angle}{90pt - 15pt}
  \pgfpointpolar{\angle}{100pt}
  \pgfgetlastxy{\co@xA}{\co@yA}
  \pgfpointpolar{\angle}{110pt}
  \pgfgetlastxy{\co@xB}{\co@yB}
  \draw [gray, thin] (\co@xA,\co@yA) -- (\co@xB,\co@yB);
  \node at (\co@xB,\co@yB) [xshift=12pt, yshift=2pt] {\tiny 0:0\@dng@degree 0\@dng@minute};
  
  % Sun
  \setlength{\angle}{\SunAngle + 90pt - 15pt}
  \pgfpointpolar{\angle}{135pt}
  \pgfgetlastxy{\co@x}{\co@y}
  \draw [red, thick] (0,0) -- (\co@x,\co@y);

  \pgfpointpolar{\angle}{140pt}
  \pgfgetlastxy{\co@x}{\co@y}
  \node at (\co@x,\co@y) [circle, fill=red!30, minimum width=15pt] {};
  \node (sun) at (\co@x,\co@y) {\theSun};
  \node [right=5pt of sun] {\small r:a\@dng@degree l\@dng@minute};

  % Moon
  \setlength{\angle}{\MoonAngle + 90pt - 15pt}
  \pgfpointpolar{\angle}{120pt}
  \pgfgetlastxy{\co@x}{\co@y}
  \draw [blue, thick] (0,0) -- (\co@x,\co@y);

  \pgfpointpolar{\angle}{125pt}
  \pgfgetlastxy{\co@x}{\co@y}
  \node at (\co@x,\co@y) [circle, fill=blue!30, minimum width=15pt] {};
  \node (moon) at (\co@x,\co@y) {\theMoon};
  \node [left=5pt of moon] {\small r:a\@dng@degree l\@dng@minute};

  \node (0,0) [circle, draw=red, fill=white, minimum width=120pt] {};
  
  % Inner lines
  
  % 45 deg cross
  \setlength{\angle}{30pt*2 + 90pt - 15pt}
  \pgfpointpolar{\angle}{60pt}
  \pgfgetlastxy{\co@xA}{\co@yA}
  \setlength{\angle}{30pt*8 + 90pt - 15pt}
  \pgfpointpolar{\angle}{60pt}
  \pgfgetlastxy{\co@xB}{\co@yB}
  \draw [gray, thin] (\co@xA,\co@yA) -- (\co@xB,\co@yB);

  \setlength{\angle}{30pt*5 + 90pt - 15pt}
  \pgfpointpolar{\angle}{60pt}
  \pgfgetlastxy{\co@xA}{\co@yA}
  \setlength{\angle}{30pt*11 + 90pt - 15pt}
  \pgfpointpolar{\angle}{60pt}
  \pgfgetlastxy{\co@xB}{\co@yB}
  \draw [gray, thin] (\co@xA,\co@yA) -- (\co@xB,\co@yB);
  
  \node (0,0) [circle, fill=white, minimum width=29.5pt] {};

  % Vertical left
  \setlength{\angle}{30pt - 5pt + 90pt - 15pt}
  \pgfpointpolar{\angle}{60pt}
  \pgfgetlastxy{\co@xA}{\co@yA}
  \setlength{\angle}{30pt*6 + 5pt + 90pt - 15pt}
  \pgfpointpolar{\angle}{60pt}
  \pgfgetlastxy{\co@xB}{\co@yB}
  \draw [gray, thin] (\co@xA,\co@yA) -- (\co@xB,\co@yB);

  % Vertical right
  \setlength{\angle}{5pt + 90pt - 15pt}
  \pgfpointpolar{\angle}{60pt}
  \pgfgetlastxy{\co@xA}{\co@yA}
  \setlength{\angle}{30pt*7 - 5pt + 90pt - 15pt}
  \pgfpointpolar{\angle}{60pt}
  \pgfgetlastxy{\co@xB}{\co@yB}
  \draw [gray, thin] (\co@xA,\co@yA) -- (\co@xB,\co@yB);

  % Horizontal lower
  \setlength{\angle}{30pt*4 - 5pt + 90pt - 15pt}
  \pgfpointpolar{\angle}{60pt}
  \pgfgetlastxy{\co@xA}{\co@yA}
  \setlength{\angle}{30pt*9 + 5pt + 90pt - 15pt}
  \pgfpointpolar{\angle}{60pt}
  \pgfgetlastxy{\co@xB}{\co@yB}
  \draw [gray, thin] (\co@xA,\co@yA) -- (\co@xB,\co@yB);

  % Horizontal upper
  \setlength{\angle}{30pt*3 + 5pt + 90pt - 15pt}
  \pgfpointpolar{\angle}{60pt}
  \pgfgetlastxy{\co@xA}{\co@yA}
  \setlength{\angle}{30pt*10 - 5pt + 90pt - 15pt}
  \pgfpointpolar{\angle}{60pt}
  \pgfgetlastxy{\co@xB}{\co@yB}
  \draw [gray, thin] (\co@xA,\co@yA) -- (\co@xB,\co@yB);

\end{tikzpicture}%
}